(()=>{var t={331:function(t,e,i){var a,r,n;n=function(){var t,e={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},i=function(){var t=function(t){this._coordinator={},this._data=[],this._radi=[],this._min=10,this._max=1,this._xField=t.xField||t.defaultXField,this._yField=t.yField||t.defaultYField,this._valueField=t.valueField||t.defaultValueField,t.radius&&(this._cfgRadius=t.radius)},i=e.defaultRadius;return t.prototype={_organiseData:function(t,e){var a=t[this._xField],r=t[this._yField],n=this._radi,s=this._data,o=this._max,h=this._min,l=t[this._valueField]||1,d=t.radius||this._cfgRadius||i;s[a]||(s[a]=[],n[a]=[]),s[a][r]?s[a][r]+=l:(s[a][r]=l,n[a][r]=d);var u=s[a][r];return u>o?(e?this.setDataMax(u):this._max=u,!1):u<h?(e?this.setDataMin(u):this._min=u,!1):{x:a,y:r,value:l,radius:d,min:h,max:o}},_unOrganizeData:function(){var t=[],e=this._data,i=this._radi;for(var a in e)for(var r in e[a])t.push({x:a,y:r,radius:i[a][r],value:e[a][r]});return{min:this._min,max:this._max,data:t}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var t=arguments[0],e=t.length;e--;)this.addData.call(this,t[e]);else{var i=this._organiseData(arguments[0],!0);i&&(0===this._data.length&&(this._min=this._max=i.value),this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[i]}))}return this},setData:function(t){var e=t.data,i=e.length;this._data=[],this._radi=[];for(var a=0;a<i;a++)this._organiseData(e[a],!1);return this._max=t.max,this._min=t.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(t){return this._max=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(t){return this._min=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(t){this._coordinator=t},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},t}(),a=function(){var t=function(t){var e=t.gradient||t.defaultGradient,i=document.createElement("canvas"),a=i.getContext("2d");i.width=256,i.height=1;var r=a.createLinearGradient(0,0,256,1);for(var n in e)r.addColorStop(n,e[n]);return a.fillStyle=r,a.fillRect(0,0,256,1),a.getImageData(0,0,256,1).data},e=function(t,e){var i=document.createElement("canvas"),a=i.getContext("2d"),r=t,n=t;if(i.width=i.height=2*t,1==e)a.beginPath(),a.arc(r,n,t,0,2*Math.PI,!1),a.fillStyle="rgba(0,0,0,1)",a.fill();else{var s=a.createRadialGradient(r,n,t*e,r,n,t);s.addColorStop(0,"rgba(0,0,0,1)"),s.addColorStop(1,"rgba(0,0,0,0)"),a.fillStyle=s,a.fillRect(0,0,2*t,2*t)}return i};function i(e){var i=e.container,a=this.shadowCanvas=document.createElement("canvas"),r=this.canvas=e.canvas||document.createElement("canvas"),n=(this._renderBoundaries=[1e4,1e4,0,0],getComputedStyle(e.container)||{});r.className="heatmap-canvas",this._width=r.width=a.width=e.width||+n.width.replace(/px/,""),this._height=r.height=a.height=e.height||+n.height.replace(/px/,""),this.shadowCtx=a.getContext("2d"),this.ctx=r.getContext("2d"),r.style.cssText=a.style.cssText="position:absolute;left:0;top:0;",i.style.position="relative",i.appendChild(r),this._palette=t(e),this._templates={},this._setStyles(e)}return i.prototype={renderPartial:function(t){t.data.length>0&&(this._drawAlpha(t),this._colorize())},renderAll:function(t){this._clear(),t.data.length>0&&(this._drawAlpha(function(t){for(var e=[],i=t.min,a=t.max,r=t.radi,n=(t=t.data,Object.keys(t)),s=n.length;s--;)for(var o=n[s],h=Object.keys(t[o]),l=h.length;l--;){var d=h[l],u=t[o][d],c=r[o][d];e.push({x:o,y:d,value:u,radius:c})}return{min:i,max:a,data:e}}(t)),this._colorize())},_updateGradient:function(e){this._palette=t(e)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=0==t.blur?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=t.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=t.height||this._height,this._opacity=255*(t.opacity||0),this._maxOpacity=255*(t.maxOpacity||t.defaultMaxOpacity),this._minOpacity=255*(t.minOpacity||t.defaultMinOpacity),this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(t){for(var i=this._min=t.min,a=this._max=t.max,r=(t=t.data||[]).length,n=1-this._blur;r--;){var s,o=t[r],h=o.x,l=o.y,d=o.radius,u=Math.min(o.value,a),c=h-d,m=l-d,g=this.shadowCtx;this._templates[d]?s=this._templates[d]:this._templates[d]=s=e(d,n);var p=(u-i)/(a-i);g.globalAlpha=p<.01?.01:p,g.drawImage(s,c,m),c<this._renderBoundaries[0]&&(this._renderBoundaries[0]=c),m<this._renderBoundaries[1]&&(this._renderBoundaries[1]=m),c+2*d>this._renderBoundaries[2]&&(this._renderBoundaries[2]=c+2*d),m+2*d>this._renderBoundaries[3]&&(this._renderBoundaries[3]=m+2*d)}},_colorize:function(){var t=this._renderBoundaries[0],e=this._renderBoundaries[1],i=this._renderBoundaries[2]-t,a=this._renderBoundaries[3]-e,r=this._width,n=this._height,s=this._opacity,o=this._maxOpacity,h=this._minOpacity,l=this._useGradientOpacity;t<0&&(t=0),e<0&&(e=0),t+i>r&&(i=r-t),e+a>n&&(a=n-e);for(var d=this.shadowCtx.getImageData(t,e,i,a),u=d.data,c=u.length,m=this._palette,g=3;g<c;g+=4){var p,_=u[g],f=4*_;f&&(p=s>0?s:_<o?_<h?h:_:o,u[g-3]=m[f],u[g-2]=m[f+1],u[g-1]=m[f+2],u[g]=l?m[f+3]:p)}d.data=u,this.ctx.putImageData(d,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var e=this.shadowCtx.getImageData(t.x,t.y,1,1).data[3],i=this._max,a=this._min;return Math.abs(i-a)*(e/255)|0},getDataURL:function(){return this.canvas.toDataURL()}},i}(),r=(t=!1,"canvas2d"===e.defaultRenderer&&(t=a),t),n=function(){for(var t={},e=arguments.length,i=0;i<e;i++){var a=arguments[i];for(var r in a)t[r]=a[r]}return t},s=function(){var t=function(){function t(){this.cStore={}}return t.prototype={on:function(t,e,i){var a=this.cStore;a[t]||(a[t]=[]),a[t].push(function(t){return e.call(i,t)})},emit:function(t,e){var i=this.cStore;if(i[t])for(var a=i[t].length,r=0;r<a;r++)(0,i[t][r])(e)}},t}();function a(){var a,s,o,h,l=this._config=n(e,arguments[0]||{});if(this._coordinator=new t,l.plugin){var d=l.plugin;if(!e.plugins[d])throw new Error("Plugin '"+d+"' not found. Maybe it was not registered.");var u=e.plugins[d];this._renderer=new u.renderer(l),this._store=new u.store(l)}else this._renderer=new r(l),this._store=new i(l);s=(a=this)._renderer,o=a._coordinator,h=a._store,o.on("renderpartial",s.renderPartial,s),o.on("renderall",s.renderAll,s),o.on("extremachange",function(t){a._config.onExtremaChange&&a._config.onExtremaChange({min:t.min,max:t.max,gradient:a._config.gradient||a._config.defaultGradient})}),h.setCoordinator(o)}return a.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(t){return this._config=n(this._config,t),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(t){return this._store.getValueAt?this._store.getValueAt(t):this._renderer.getValueAt?this._renderer.getValueAt(t):null}},a}();return{create:function(t){return new s(t)},register:function(t,i){e.plugins[t]=i}}},t.exports?t.exports=n():void 0===(r="function"==typeof(a=n)?a.call(e,i,e,t):a)||(t.exports=r)}},e={};function i(a){var r=e[a];if(void 0!==r)return r.exports;var n=e[a]={exports:{}};return t[a].call(n.exports,n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var a in e)i.o(e,a)&&!i.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";var t=i(331),e=i.n(t);function a(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,a=Array(e);i<e;i++)a[i]=t[i];return a}looker.plugins.visualizations.add({id:"image_heatmap_lib",label:"Image Heatmap (Library)",options:{imageUrl:{type:"string",label:"Image URL",display:"text",default:"https://raw.githubusercontent.com/zacharagosa/KPI-Tile/main/map_background.png",section:"Data"},coordinateMode:{type:"string",label:"Coordinate Mode",values:[{Pixels:"pixels"},{Percent:"percent"}],display:"select",default:"percent",section:"Data"},colorGradient:{type:"string",label:"Color Gradient",values:[{Classic:"classic"},{Fire:"fire"},{"Blue/Green":"cool"}],display:"select",default:"classic",section:"Style"},radius:{type:"number",label:"Point Radius",default:20,display:"range",min:1,max:100,section:"Style"},blur:{type:"number",label:"Blur",default:.85,display:"range",min:0,max:1,step:.05,section:"Style"},opacity:{type:"number",label:"Heatmap Opacity",default:.6,display:"range",min:0,max:1,step:.1,section:"Style"}},create:function(t,e){var i=this;this.container=t.appendChild(document.createElement("div")),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.container.style.display="flex",this.container.style.justifyContent="center",this.container.style.alignItems="center",this.img=document.createElement("img"),this.img.style.position="absolute",this.img.style.top="0",this.img.style.left="0",this.container.appendChild(this.img),this.heatmapWrapper=document.createElement("div"),this.heatmapWrapper.style.position="absolute",this.heatmapWrapper.style.top="0",this.heatmapWrapper.style.left="0",this.container.appendChild(this.heatmapWrapper),this._heatmapInstance=null,this._imgLoaded=!1,this._imgError=!1,this.img.crossOrigin="Anonymous",this.img.onload=function(){i._imgLoaded=!0,i._imgError=!1,i.frameUpdate()},this.img.onerror=function(){i._imgLoaded=!1,i._imgError=!0,i.frameUpdate()},this.gradients={classic:{".5":"blue",".8":"red",".95":"white"},fire:{".4":"black",".6":"darkred",".8":"red",".95":"orange",1:"white"},cool:{".4":"white",".6":"cyan",".8":"blue",".9":"indigo",1:"black"}}},frameUpdate:function(){var t;this._lastArgs&&this.updateAsync.apply(this,function(t){if(Array.isArray(t))return a(t)}(t=this._lastArgs)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return a(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?a(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())},updateAsync:function(t,i,a,r,n,s){var o=this;this._lastArgs=[t,i,a,r,n,s],this.clearErrors();var h=a.imageUrl;if(h){if(this.img.src!==h)return this._imgLoaded=!1,this._imgError=!1,void(this.img.src=h);if(this._imgError)this.addError({title:"Image Load Error",message:"Could not load image from URL: ".concat(h)});else if(this._imgLoaded){var l=r.fields.dimensions,d=r.fields.measures;if(l.length<2)this.addError({title:"Insufficient Dimensions",message:"This chart requires 2 dimensions (X, Y)."});else if(d.length<1)this.addError({title:"Insufficient Measures",message:"This chart requires 1 measure (Intensity)."});else{var u,c,m=l[0].name,g=l[1].name,p=d[0].name,_=i.getBoundingClientRect(),f=_.width,y=_.height,v=this.img.naturalWidth/this.img.naturalHeight;f/y>v?u=(c=y)*v:c=(u=f)/v,this.img.width=u,this.img.height=c,this.img.style.width="".concat(u,"px"),this.img.style.height="".concat(c,"px"),this.heatmapWrapper.style.width="".concat(u,"px"),this.heatmapWrapper.style.height="".concat(c,"px"),this.heatmapWrapper.innerHTML="",this._heatmapInstance=e().create({container:this.heatmapWrapper,radius:a.radius||20,maxOpacity:a.opacity||.6,minOpacity:0,blur:a.blur||.85,gradient:this.gradients[a.colorGradient]||this.gradients.classic});var x=[],w=0;t.forEach(function(t){var e,i,r=t[m].value,n=t[g].value,s=t[p].value;null!=r&&null!=n&&(s>w&&(w=s),"percent"===a.coordinateMode?(e=r/100*u,i=n/100*c):(e=r*(u/o.img.naturalWidth),i=n*(c/o.img.naturalHeight)),x.push({x:Math.round(e),y:Math.round(i),value:s}))}),this._heatmapInstance.setData({max:w,data:x}),s()}}}else this.addError({title:"Missing Image",message:"Please provide an Image URL in the options."})}})})()})();