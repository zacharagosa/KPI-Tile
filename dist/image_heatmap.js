(()=>{function e(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,a){if(e){if("string"==typeof e)return t(e,a);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?t(e,a):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,i=Array(t);a<t;a++)i[a]=e[a];return i}looker.plugins.visualizations.add({id:"image_heatmap",label:"Image Heatmap",options:{imageUrl:{type:"string",label:"Image URL",display:"text",default:"https://raw.githubusercontent.com/zacharagosa/KPI-Tile/main/map_background.png",section:"Data"},coordinateMode:{type:"string",label:"Coordinate Mode",values:[{Pixels:"pixels"},{Percent:"percent"}],display:"select",default:"percent",section:"Data"},colorGradient:{type:"string",label:"Color Gradient",values:[{Classic:"classic"},{Fire:"fire"},{"Blue/Green":"cool"}],display:"select",default:"classic",section:"Style"},radius:{type:"number",label:"Point Radius",default:20,display:"range",min:1,max:100,section:"Style"},blur:{type:"number",label:"Blur",default:15,display:"range",min:0,max:50,section:"Style"},opacity:{type:"number",label:"Heatmap Opacity",default:.7,display:"range",min:0,max:1,step:.1,section:"Style"},showGrid:{type:"boolean",label:"Show Grid",default:!1,section:"Style"}},create:function(e,t){var a=this;this.container=e.appendChild(document.createElement("div")),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.container.style.display="flex",this.container.style.justifyContent="center",this.container.style.alignItems="center",this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.container.appendChild(this.canvas),this._img=new Image,this._imgLoaded=!1,this._imgError=!1,this._img.crossOrigin="Anonymous",this._img.onload=function(){a._imgLoaded=!0,a._imgError=!1,a.frameUpdate()},this._img.onerror=function(){a._imgLoaded=!1,a._imgError=!0,a.frameUpdate()},this.gradients={classic:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},fire:{.4:"black",.6:"darkred",.8:"red",.95:"orange",1:"white"},cool:{.4:"white",.6:"cyan",.8:"blue",.9:"indigo",1:"black"}}},frameUpdate:function(){this._lastArgs&&this.updateAsync.apply(this,e(this._lastArgs))},updateAsync:function(t,a,i,r,n,s){var o=this;this._lastArgs=[t,a,i,r,n,s],this.clearErrors();var l=i.imageUrl;if(l){if(this._img.src!==l)return this._imgLoaded=!1,this._imgError=!1,void(this._img.src=l);if(this._imgError)this.addError({title:"Image Load Error",message:"Could not load image from URL: ".concat(l)});else if(this._imgLoaded){var d=r.fields.dimensions,c=r.fields.measures;if(d.length<2)this.addError({title:"Insufficient Dimensions",message:"This chart requires 2 dimensions (X, Y)."});else if(c.length<1)this.addError({title:"Insufficient Measures",message:"This chart requires 1 measure (Intensity)."});else{var h,m,g=d[0].name,u=d[1].name,f=c[0].name,p=a.getBoundingClientRect(),y=p.width,v=p.height,b=this._img.width/this._img.height;y/v>b?h=(m=v)*b:m=(h=y)/b,this.canvas.width=h,this.canvas.height=m,this.canvas.style.width="".concat(h,"px"),this.canvas.style.height="".concat(m,"px");var _=this.canvas.getContext("2d");_.drawImage(this._img,0,0,h,m);var w=document.createElement("canvas");w.width=h,w.height=m;var I=w.getContext("2d"),x=i.radius||20,S=i.blur||15,E=Math.max.apply(Math,e(t.map(function(e){return e[f].value||0})));t.forEach(function(e){var t,a,r=e[g].value,n=e[u].value,s=e[f].value;null!=r&&null!=n&&("percent"===i.coordinateMode?(t=r/100*h,a=n/100*m):(t=r*(h/o._img.width),a=n*(m/o._img.height)),function(e,t,a){var i=E>0?a/E:0;I.globalAlpha=Math.max(.05,i),I.beginPath();var r=x+S,n=I.createRadialGradient(e,t,x-S>0?x-S:0,e,t,r);n.addColorStop(0,"rgba(0,0,0,1)"),n.addColorStop(1,"rgba(0,0,0,0)"),I.fillStyle=n,I.arc(e,t,r,0,2*Math.PI),I.fill()}(t,a,s))});var A=this.gradients[i.colorGradient]||this.gradients.classic,C=document.createElement("canvas");C.width=256,C.height=1;var L=C.getContext("2d"),M=L.createLinearGradient(0,0,256,1);for(var T in A)M.addColorStop(parseFloat(T),A[T]);L.fillStyle=M,L.fillRect(0,0,256,1);for(var G=L.getImageData(0,0,256,1).data,P=I.getImageData(0,0,h,m),U=P.data,k=0;k<U.length;k+=4){var R=U[k+3];if(R>0){var D=4*R;U[k]=G[D],U[k+1]=G[D+1],U[k+2]=G[D+2],U[k+3]=255*(i.opacity||.7),R<10&&(U[k+3]=0)}}if(I.putImageData(P,0,0),_.drawImage(w,0,0),i.showGrid){_.strokeStyle="rgba(128, 128, 128, 0.5)",_.lineWidth=1,_.font="10px sans-serif",_.fillStyle="rgba(0, 0, 0, 0.7)",_.textAlign="center",_.textBaseline="middle";for(var B=0;B<=100;B+=10){var j=B/100*h;_.beginPath(),_.moveTo(j,0),_.lineTo(j,m),_.stroke(),B>0&&B<100&&_.fillText(B,j,10)}for(var O=0;O<=100;O+=10){var q=O/100*m;_.beginPath(),_.moveTo(0,q),_.lineTo(h,q),_.stroke(),O>0&&O<100&&_.fillText(O,10,q)}}s()}}}else this.addError({title:"Missing Image",message:"Please provide an Image URL in the options."})}})})();